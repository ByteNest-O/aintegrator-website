name: Check if Image Builds

on:
  pull_request:
    types: [labeled]

# Essential for the 'gh' CLI to modify PRs
permissions:
  pull-requests: write
  contents: read

jobs:
  check-label-and-build:
    if: github.event.label.name == 'build-check'
    uses: AIntegrator/github-workflows/.github/workflows/build-check.yml@main
    with:
      image-name: azytaku/aintegrator-frontend
      dockerfile: Dockerfile
      platform: linux/amd64
      manual-tag: 'testing-0.0.1'

  manage-labels:
    needs: check-label-and-build
    if: always() && github.event.label.name == 'build-check'
    runs-on: ubuntu-latest
    steps:
      - name: Update PR Labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_RESULT: ${{ needs.check-label-and-build.result }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # 1. Always remove the trigger label first
          gh pr edit $PR_NUMBER --remove-label "build-check" --repo $REPO

          # 2. Add the specific status label based on the build outcome
          if [ "$BUILD_RESULT" == "success" ]; then
            gh pr edit $PR_NUMBER --add-label "build-passed" --repo $REPO
            # Optional: remove the failed label if it was there from a previous run
            gh pr edit $PR_NUMBER --remove-label "build-failed" --repo $REPO || true
          else
            gh pr edit $PR_NUMBER --add-label "build-failed" --repo $REPO
            # Optional: remove the passed label if it was there from a previous run
            gh pr edit $PR_NUMBER --remove-label "build-passed" --repo $REPO || true
          fi
